SELECT
	SU.DAT_CREATION AS DATA_CADASTRO,
	M.IDT_SAFEPAY_USER AS ID_CLIENTE,
	DECODE(SR.IND_STATUS,'A','ATIVO','I','INATIVO','PENDENTE') AS STATUS_CONTA,
	M.COD_ACQUIRER_CATEGORY AS MCC,
	M.DES_ACQUIRER_CATEGORY AS DESC_MCC,
	NVL(SALDO.SALDO,0) AS TPV_2020
	M1.DAT_CREATION AS DATA_ULTIMA_TRANSACAO,
	M1.IDT_TRANSACTION AS ID_ULTIMA_TRANSACAO,
	M1.COD_SAFEPAY_TRANSACTION AS COD_TRANSACAO,
	M1.NUM_TRANSACTION_TOTAL_VALUE AS VALOR_TRANSACAO
ROM MCCRISCO M
LEFT JOIN SAFEPAY_ADM.SFEPAY_USER SU ON M.IDT_SAFEPAY_USER = SU.IDT_SAFEPAY_USER
LEFT JOIN SAFEPAY_ADM.SAFEUSER_REGISTERED SR ON M.IDT_SAFEPAY_USER = SR.IDT_SAFEPAY_USER
LEFT JOIN	(	SELECT
					DAT_CREATION,
					IDT_SAFEPAY_CREDITOR,
					IDT_TRANSACTION,
					COD_SAFEPAY_TRANSACTION,
					NUM_TRANSACTION_TOTAL_VALUE
				FROM SAFEPAY_ADM.TRANSACTION T1
				WHERE EXISTIS	(	SELECT * 
									FROM MCCRISCO M
									WHERE T.IDT_SAFEPAY_CREDITOR = M.IDT_SAFEPAY_USER)
				AND T.IDT_TRANSACTION IN (	SELECT MAX(T1.IDT_TRANSACTION)
											FROM SAFEPAY_ADM.TRANSACTION T1
											WHERE T.IDT_SAFEPAY_CREDITOR = T1.IDT_SAFEPAY_CREDITOR)
				)M1 ON M.IDT_SAFEPAY_USER = M1.IDT_SAFEPAY_CREDITOR
LEFT JOIN	(	SELECT
					IDT_SAFEPAY_CREDITOR,
					SUM(NUM_TRANSACTION_TOTAL_VALUE) AS SALDO
				FROM SAFEPAY_ADM.TRANSACTION
				WHERE DAT_START_ESCROW IS NOT NULL 
				AND DAT_CREATION >= DATE'2020-01-01'
				GROUP BY IDT_SAFEPAY_CREDITOR
				)SALDO ON M.IDT_SAFEPAY_USER = SALDO.IDT_SAFEPAY_CREDITOR
;