SELECT
	T.DAT_CREATION AS DATA_TRANSACAO,
	IP.DATA_TRANSACAO AS DATA_TRANSACAO_PLAN,
	IP.ARN,
	COALESCE(CC.NUM_CREDIT_CARD_DISPLAY, DC.NUM_DEBIT_CARD_DISPLAY) AS BIN_PORTADOR,
	COALESCE(CC.COD_AUTHORIZATION, DC.COD_AUTHORIZATION) AS AUTORIZACAO,
	C.DAT_CREATION AS DATA_CONTESTACAO,
	CONCAT(P.NAM_PERSON, CONCAT(' ',I.NAM_LAST)) AS NOME_COMPLETO,
	COALESCE(PF.NUM_CPF, PJ.NUM_CNPJ) AS DOCUMENTO,
	T.IDT_SAFEPAY_CREDITOR AS ID_VENDEDOR,
	DECODE(SU.IND_USER_TYPE, 'C', 'Comprador', 'P', 'Pessoal', 'V', 'Vendedor', 'E', 'Empresarial', 'R', 'Comprador', 'S', 'Vendedor') as DES_TIPO_CONTA,
	COALESCE(CC.COD_NSU_OPERATOR, DC.COD_NSU_OPERATOR) AS NSU,
	COALESCE(CC.COD_INTEGRATOR, CC.COD_TID_OPERATOR, DC.COD_INTEGRATOR) AS TID,
	T.IDT_SAFEPAY_CREDITOR,
	T.IDT_TRANSACTION,
	T.COD_SAFEPAY_TRANSACTION,
	DECODE(T.IDT_TRANSACTION_TYPE, 	'1', 'Pagamento',
									'2', 'Transferência',
									'3', 'Adição de fundos',
									'4', 'Saque',
									'5', 'Cobrança',
									'6', 'Doação',
									'7', 'Bônus',
									'8', 'Reversão de Bônus',
									'9', 'Movimentação Operacional',
									'10', 'Doação Politica',
									'11', 'Assinatura',
									'12', 'Campanhas Bonificadas',
									'13', 'Pagamento secundário',
									'14', 'Validadora'
		) AS TIPO_TRANSACAO,
	DECODE(T.IDT_MAIN_PAYMENT_METHOD,	'1', 	'TEF',
										'2',	'Boleto',
										'3',	'Cartão de Crédito',
										'4',	'Saldo',
										'5',	'Oi Pago',
										'6',	'PinCode',
										'7',	'Depósito em Conta',
										'8',	'Cartão de Débito',
										'9',	'Débito Automático em Conta',
										'10',	'Voucher',
										'11',	'Pix'
		) AS METODO_PAGAMENTO,
	(SELECT TS.DES_INTERNAL_STATUS FROM SAFEPAY_ADM.TRANSACTION_STATUS TS WHERE T.IDT_TRANSACTION_STATUS = TS.IDT_TRANSACTION_STATUS) AS STATUS_TRANSACAO,
	T.NUM_TRANSACTION_TOTAL_VALUE AS VALOR_TRANSACAO,
	CASE C.IND_STATUS
			WHEN 	'AD'	THEN	'Negado automaticamente'
			WHEN 	'AL'	THEN	'Analisado'
			WHEN 	'AN'	THEN	'Em análise'
			WHEN	'AP'	THEN	'Aprovado'
			WHEN	'AW'	THEN	'Negado automaticamente - Aguardando notificação'
			WHEN	'CC'	THEN	'Encerrada / Chargeback debitado'
			WHEN	'DE'	THEN	'Negado'
			WHEN	'ER'	THEN	'Erro de Processamento'
			WHEN	'EX'	THEN	'Expirado'
			WHEN	'NB'	THEN	'Não Bloqueado'
			WHEN	'NN'	THEN	'Não Notificado'
			WHEN	'RL'	THEN	'Reporte liberado'
			WHEN	'RR'	THEN	'Reavaliação de reporte'
			WHEN	'TC'	THEN	'Encerrada / Transação estornada'
			WHEN	'WN'	THEN	'Aguardando notificação'
			WHEN	'WR'	THEN	'Aguardando comprovante'
	END 
	STATUS_CONTESTACAO
FROM IMPORT_PLANS IP 
LEFT JOIN SAFEPAY_ADM.CREDIT_CARD CC ON IP.BIN_PORTADOR = CC.NUM_CREDIT_CARD_DISPLAY AND IP.AUTORIZACAO = CC.COD_AUTHORIZATION
LEFT JOIN SAFEPAY_ADM.DEBIT_CARD DC ON IP.BIN_PORTADOR = DC.NUM_DEBIT_CARD_DISPLAY AND IP.AUTORIZACAO = DC.COD_AUTHORIZATION
LEFT JOIN SAFEPAY_ADM.TRANSACTION_PAYMENT_ATTEMPT TPA ON CC.IDT_PAYMENT_ATTEMPT = TPA.IDT_PAYMENT_ATTEMPT OR DC.IDT_PAYMENT_ATTEMPT = TPA.IDT_PAYMENT_ATTEMPT
--LEFT JOIN SAFEPAY_ADM.TRANSACTION T ON TPA.IDT_TRANSACTION = T.IDT_TRANSACTION -- LEFT JOIN com qualquer tipo de Transação
LEFT JOIN SAFEPAY_ADM.TRANSACTION T ON TPA.IDT_TRANSACTION = T.IDT_TRANSACTION AND T.IDT_TRANSACTION_TYPE = 3
LEFT JOIN SAFEPAY_ADM.CONTESTATION C ON T.IDT_TRANSACTION = C.IDT_TRANSACTION
LEFT JOIN SAFEPAY_ADM.SAFEPAY_USER SU ON T.IDT_SAFEPAY_CREDITOR = SU.IDT_SAFEPAY_USER
LEFT JOIN SAFEPAY_ADM.SAFEUSER_REGISTERED SR ON T.IDT_SAFEPAY_CREDITOR = SR.IDT_SAFEPAY_USER
LEFT JOIN UOLBR.PERSON ON SR.IDT_PERSON = P.IDT_PERSON
LEFT JOIN UOLBR.CADASTRO_PESSOA_FISICA PF ON SR.IDT_PERSON = PF.IDT_PERSON
LEFT JOIN UOLBR.CADASTRO_PESSOA_JURIDICA PJ ON SR.IDT_PERSON = PJ.IDT_PERSON
LEFT JOIN UOLBR.INDIVIDUAL I ON SR.IDT_PERSON = I.IDT_PERSON
WHERE 1 = 1
AND T.DAT_CREATION >= DATE'2018-05-01' 
;
